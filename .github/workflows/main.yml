name: Testing API workflows

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
    - name: checkout
      uses: actions/checkout@v4

    - name: Restore
      run: dotnet restore API.slnx

    - name: build API
      run: dotnet build API/API.csproj -c Release

    - name: Start API (background)
      working-directory: API
      shell: bash
      env:
        ASPNETCORE_ENVIRONMENT: Development
      run: |
        export ASPNETCORE_URLS = "http://localhost:5275"
        dotnet run --no-build --configuration Release

    - name: Wait for API readiness
      shell: bash
      run: |
        set -e
        BASE_URL="http://localhost:5275/health"
        for i in {1..30}; do
          if curl -fsS "$BASE_URL" > /dev/null 2>&1; then
            echo "API is ready on $BASE_URL"
            exit 0
          fi
          echo "Waiting for API... attempt $i"
          sleep 1
        done
        echo "API did not become ready in time"
        exit 1
    
